#!/bin/bash
# ccmem - Claude Code Memory System CLI
# Main entry point for the file-based memory system

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_DIR="$(dirname "$SCRIPT_DIR")"
MEMORY_DIR="${CLAUDE_MEMORY_DIR:-$HOME/.claude/memory}"
PYTHON_LIB="$PLUGIN_DIR/scripts/lib/memory_lib.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help message
show_help() {
    cat << EOF
ccmem - Claude Code Memory System

Usage: ccmem <command> [options]

Commands:
  search <query>     Search memories by query
  list               List all memories
  list obs           List recent observations
  show <id>          Show memory details
  create             Create a new memory (interactive)
  reinforce <id>     Reinforce a memory (positive feedback)
  correct <id>       Correct a memory (negative feedback)
  analyze            Run pattern analysis on observations
  index              Build search index
  export [file]      Export memories to JSON
  import <file>      Import memories from JSON
  sync               Sync with CLAUDE.md (import only)
  promote            Review and promote memories to CLAUDE.md
  decisions          Show promotion decision history
  stats              Show memory system statistics
  help               Show this help message

Options:
  --project          Filter by current project
  --global           Filter to global memories only
  --confidence N     Minimum confidence threshold (0.0-1.0)
  --tag <tag>        Filter by tag
  --type <type>      Filter by memory type
  --limit N          Limit number of results

Examples:
  ccmem search "package manager"
  ccmem list --project --confidence 0.8
  ccmem reinforce 2026-01-29-pnpm-preference
  ccmem analyze
  ccmem stats
  ccmem promote                    # Review candidates interactively
  ccmem promote --dry-run          # Preview what would be promoted
  ccmem decisions                  # View promotion history

EOF
}

# Search memories
cmd_search() {
    local query="$1"
    shift
    local project=""
    local min_confidence="0.0"
    local limit="10"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --project)
                project=$(pwd)
                ;;
            --confidence)
                min_confidence="$2"
                shift
                ;;
            --limit)
                limit="$2"
                shift
                ;;
        esac
        shift
    done

    if [ -z "$query" ]; then
        echo -e "${RED}Error: Search query required${NC}"
        exit 1
    fi

    echo -e "${BLUE}Searching for: $query${NC}"
    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import search_memories, get_project_hash

project_hash = get_project_hash("$project") if "$project" else None
results = search_memories(
    query="$query",
    project_hash=project_hash,
    limit=$limit,
    min_confidence=$min_confidence
)

if not results:
    print("No memories found")
else:
    for m in results:
        conf = m['metadata']['confidence']
        scope = m['scope']['type']
        print(f"  [{conf:.0%}] {m['id']} ({scope})")
        print(f"       {m['content']['title']}")
EOF
}

# List memories
cmd_list() {
    local scope="all"
    local project=""
    local min_confidence="0.0"
    local memory_type=""
    local tag=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --project)
                scope="project"
                project=$(pwd)
                ;;
            --global)
                scope="global"
                ;;
            --confidence)
                min_confidence="$2"
                shift
                ;;
            --type)
                memory_type="$2"
                shift
                ;;
            --tag)
                tag="$2"
                shift
                ;;
        esac
        shift
    done

    echo -e "${BLUE}Listing memories...${NC}"
    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import list_memories, get_project_hash

project_hash = get_project_hash("$project") if "$project" else None
memories = list_memories(
    scope="$scope",
    project_hash=project_hash,
    memory_type="$memory_type" or None,
    tag="$tag" or None,
    min_confidence=$min_confidence
)

if not memories:
    print("No memories found")
else:
    print(f"Found {len(memories)} memories:")
    for m in memories:
        conf = m['metadata']['confidence']
        scope = m['scope']['type']
        status = m['metadata']['status']
        print(f"  [{conf:.0%}] {m['id']} ({scope}, {status})")
        print(f"       {m['content']['title']}")
EOF
}

# List observations
cmd_list_obs() {
    local limit="${1:-20}"
    local filter_type=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --type)
                filter_type="$2"
                shift
                ;;
            -n|--limit)
                limit="$2"
                shift
                ;;
        esac
        shift
    done

    if [ ! -f "$MEMORY_DIR/observations.jsonl" ]; then
        echo -e "${YELLOW}No observations found${NC}"
        exit 0
    fi

    echo -e "${BLUE}Recent observations (last $limit):${NC}"
    echo

    # Read and parse observations
    python3 << EOF
import json
import sys

observations = []
with open("$MEMORY_DIR/observations.jsonl", 'r') as f:
    for line in f:
        line = line.strip()
        if line:
            try:
                obs = json.loads(line)
                observations.append(obs)
            except:
                pass

# Filter by type if specified
filter_type = "$filter_type"
if filter_type:
    observations = [o for o in observations if o.get('type') == filter_type]

# Show last N observations
limit = int($limit)
for obs in observations[-limit:]:
    ts = obs.get('timestamp', 'unknown')
    session = obs.get('session_id', 'unknown')[:8]
    obs_type = obs.get('type', 'unknown')
    data = obs.get('data', {})

    # Format based on type
    if obs_type == 'prompt':
        content = data.get('prompt', '')[:60]
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → {content}...")
    elif obs_type == 'tool_use':
        tool = data.get('tool', 'unknown')
        desc = data.get('description', '')[:50]
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → Tool: {tool} - {desc}...")
    elif obs_type == 'file_modified':
        path = data.get('path', 'unknown')
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → File: {path}")
    elif obs_type == 'session_start':
        project = data.get('project_path', 'unknown')
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → Project: {project}")
    elif obs_type == 'session_end':
        duration = data.get('duration_minutes', 0)
        count = data.get('observation_count', 0)
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → Duration: {duration}min, Observations: {count}")
    else:
        print(f"[{ts}] {obs_type:12} (session:{session}...)")
        print(f"  → {str(data)[:60]}...")
    print()

print(f"Total: {len(observations)} observations")
EOF
}

# Show memory details
cmd_show() {
    local memory_id="$1"

    if [ -z "$memory_id" ]; then
        echo -e "${RED}Error: Memory ID required${NC}"
        exit 1
    fi

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import load_memory
import json

memory = load_memory("$memory_id")
if not memory:
    print(f"Memory not found: $memory_id")
    sys.exit(1)

meta = memory['metadata']
print(f"ID: {memory['id']}")
print(f"Type: {memory['type']}")
print(f"Scope: {memory['scope']['type']}")
if memory['scope']['path']:
    print(f"Path: {memory['scope']['path']}")
print(f"Title: {memory['content']['title']}")
print(f"Description: {memory['content']['description']}")
print(f"Action: {memory['content']['action']}")
print(f"Confidence: {meta['confidence']}")
print(f"Status: {meta['status']}")
print(f"Created: {meta['created_at']}")
print(f"Accessed: {meta['access_count']} times")
print(f"Tags: {', '.join(memory['tags'])}")
print(f"Evidence count: {len(memory.get('evidence', []))}")
EOF
}

# Reinforce memory
cmd_reinforce() {
    local memory_id="$1"

    if [ -z "$memory_id" ]; then
        echo -e "${RED}Error: Memory ID required${NC}"
        exit 1
    fi

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import update_memory

success = update_memory(
    "$memory_id",
    outcome="accepted"
)
if success:
    print("✓ Memory reinforced")
else:
    print("✗ Memory not found")
    sys.exit(1)
EOF
}

# Correct memory
cmd_correct() {
    local memory_id="$1"
    shift
    local feedback="$*"

    if [ -z "$memory_id" ]; then
        echo -e "${RED}Error: Memory ID required${NC}"
        exit 1
    fi

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import update_memory

success = update_memory(
    "$memory_id",
    outcome="rejected"
)
if success:
    print("✓ Memory corrected (confidence reduced)")
else:
    print("✗ Memory not found")
    sys.exit(1)
EOF
}

# Analyze observations
cmd_analyze() {
    echo -e "${BLUE}Running pattern analysis...${NC}"

    # Check if there are observations to analyze
    local obs_count=0
    if [ -f "$MEMORY_DIR/observations.jsonl" ]; then
        obs_count=$(wc -l < "$MEMORY_DIR/observations.jsonl" | tr -d ' ')
    fi

    echo "Found $obs_count observations"

    if [ "$obs_count" -lt 10 ]; then
        echo -e "${YELLOW}Not enough observations for meaningful analysis (need 10+)${NC}"
        exit 0
    fi

    # Spawn analyzer agent
    echo -e "${GREEN}Spawning analyzer agent...${NC}"
    echo "(In a real implementation, this would spawn a background agent)"
    echo "For now, run: claude -p 'Read ~/.claude/memory/agents/analyzer.md and execute'"
}

# Build search index
cmd_index() {
    echo -e "${BLUE}Building search index...${NC}"
    python3 "$MEMORY_DIR/scripts/build-index.py"
    echo -e "${GREEN}✓ Index built${NC}"
}

# Show statistics
cmd_stats() {
    echo -e "${BLUE}Memory System Statistics${NC}"
    echo "========================"

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import load_config, load_index
import os

config = load_config()
index = load_index()

# Count files
obs_count = 0
if os.path.exists("$MEMORY_DIR/observations.jsonl"):
    with open("$MEMORY_DIR/observations.jsonl") as f:
        obs_count = len(f.readlines())

mem_count = index['stats']['total_count']
global_count = index['stats']['global_count']
project_count = index['stats']['project_count']

print(f"Version: {config['version']}")
print(f"Created: {config['created_at']}")
print()
print(f"Sessions: {config['identity']['session_count']}")
print(f"Total Observations: {config['identity']['total_observations']} (file: {obs_count})")
print(f"Total Memories: {mem_count}")
print(f"  - Global: {global_count}")
print(f"  - Project-specific: {project_count}")
print()
if config['last_session']:
    print(f"Last Session: {config['last_session']}")
if config['last_analysis']:
    print(f"Last Analysis: {config['last_analysis']}")
else:
    print("Last Analysis: Never")
print()
print(f"Memory Directory: $MEMORY_DIR")
EOF
}

# Export memories
cmd_export() {
    local output_file="${1:-memories-export-$(date +%Y%m%d).json}"

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import list_memories
import json

memories = list_memories()
export = {
    "version": "1.1.0",
    "exported_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "count": len(memories),
    "memories": memories
}

with open("$output_file", 'w') as f:
    json.dump(export, f, indent=2)

print(f"✓ Exported {len(memories)} memories to $output_file")
EOF
}

# Import memories
cmd_import() {
    local input_file="$1"

    if [ -z "$input_file" ] || [ ! -f "$input_file" ]; then
        echo -e "${RED}Error: Import file required${NC}"
        exit 1
    fi

    python3 << EOF
import sys
sys.path.insert(0, "$PLUGIN_DIR/scripts/lib")
from memory_lib import create_memory
import json

with open("$input_file", 'r') as f:
    data = json.load(f)

count = 0
for m in data.get('memories', []):
    try:
        create_memory(
            memory_type=m['type'],
            content=m['content'],
            triggers=m['triggers'],
            tags=m['tags'],
            evidence=m.get('evidence', []),
            confidence=m['metadata']['confidence'],
            scope_type=m['scope']['type'],
            scope_path=m['scope']['path'],
            memory_id=m['id']
        )
        count += 1
    except Exception as e:
        print(f"Error importing {m['id']}: {e}")

print(f"✓ Imported {count} memories")
EOF
}

# Sync with CLAUDE.md
cmd_sync() {
    local action=""
    local project=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --promote)
                echo -e "${YELLOW}Warning: --promote is deprecated. Use 'ccmem promote' instead.${NC}"
                echo "Running 'ccmem promote'..."
                cmd_promote "$@"
                return
                ;;
            --import)
                action="--import"
                ;;
            --project)
                project="$(pwd)"
                ;;
        esac
        shift
    done

    echo -e "${BLUE}Syncing with CLAUDE.md...${NC}"
    python3 "$PLUGIN_DIR/scripts/sync-claude-md.py" ${action:---sync} ${project:+--project "$project"}
}

# Promote memories to CLAUDE.md (interactive workflow)
cmd_promote() {
    local dry_run=""
    local auto=""
    local scope="all"
    local project=""
    local list_only=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run="--dry-run"
                ;;
            --auto)
                auto="--auto"
                ;;
            --scope)
                scope="$2"
                shift
                ;;
            --project)
                scope="project"
                project="$(pwd)"
                ;;
            --global)
                scope="global"
                ;;
            --list)
                list_only="--list-candidates"
                ;;
        esac
        shift
    done

    if [ -n "$list_only" ]; then
        python3 "$PLUGIN_DIR/scripts/promote-workflow.py" --list-candidates --scope "$scope" ${project:+--project "$project"}
    else
        python3 "$PLUGIN_DIR/scripts/promote-workflow.py" --promote --scope "$scope" ${project:+--project "$project"} ${dry_run} ${auto}
    fi
}

# Show promotion decisions
cmd_decisions() {
    python3 "$PLUGIN_DIR/scripts/promote-workflow.py" --decisions
}

# Main command dispatcher
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        search)
            cmd_search "$@"
            ;;
        list)
            # Check if second argument is "obs" or "observations"
            if [[ "$1" == "obs" || "$1" == "observations" ]]; then
                shift
                cmd_list_obs "$@"
            else
                cmd_list "$@"
            fi
            ;;
        show)
            cmd_show "$@"
            ;;
        reinforce)
            cmd_reinforce "$@"
            ;;
        correct)
            cmd_correct "$@"
            ;;
        analyze)
            cmd_analyze "$@"
            ;;
        index)
            cmd_index "$@"
            ;;
        stats)
            cmd_stats "$@"
            ;;
        export)
            cmd_export "$@"
            ;;
        import)
            cmd_import "$@"
            ;;
        sync)
            cmd_sync "$@"
            ;;
        promote)
            cmd_promote "$@"
            ;;
        decisions)
            cmd_decisions
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
